<!doctype html>
<html>
<head>
<meta charset="utf-8">
<script src="../dist/mapbox-gl.js"></script>
<style>.mapboxgl-canary { background-color: salmon; }</style>
</head>
<body style="margin: 0; padding: 0"><div id="map" style="width: 500px; height: 500px"></div></body>
<script>
mapboxgl.accessToken = 'pk.eyJ1IjoibW91cm5lciIsImEiOiJWWnRiWG1VIn0.j6eccFHpE3Q04XPLI7JxbA';
mapboxgl.workerCount = 1;

var map = new mapboxgl.Map({
    container: document.getElementById('map'),
    style: 'mapbox://styles/mapbox/streets-v11',
    center: [-77.07842066675323, 38.890315130853566],
    zoom: 11.1,
    fadeDuration: 0
});

const gl = map.painter.context && map.painter.context.gl || map.painter.gl;
const vao = map.painter.context && map.painter.context.extVertexArrayObject || map.painter.extVertexArrayObject;

const stats = {
    'buffer-data-bytes': 0,
    'tex-image-2d-bytes': 0,
    'draw-calls': 0,
    'bind-vao-calls': 0,
    'use-program-calls': 0
};

const {bufferData, texImage2D, drawElements, drawArrays, useProgram} = gl;
const {bindVertexArrayOES} = vao;

gl.bufferData = (...args) => {
    stats['buffer-data-bytes'] += args[1].byteLength;
    bufferData.call(gl, ...args);
};
gl.texImage2D = (...args) => {
    stats['tex-image-2d-bytes'] += args[5] ? args[5].width * args[5].height : args[3] * args[4];
    texImage2D.call(gl, ...args);
};
gl.drawElements = (...args) => {
    stats['draw-calls']++;
    drawElements.call(gl, ...args);
};
gl.drawArrays = (...args) => {
    stats['draw-calls']++;
    drawArrays.call(gl, ...args);
};
gl.useProgram = (...args) => {
    stats['use-program-calls']++;
    useProgram.call(gl, ...args);
};
vao.bindVertexArrayOES  = (...args) => {
    stats['bind-vao-calls']++;
    bindVertexArrayOES.call(vao, ...args);
};

map.on('render', function logStats() {
    if (!map._sourcesDirty && !map._repaint && !map._styleDirty && !map._placementDirty && map.loaded()) {
        console.log(JSON.stringify(stats, null, 2));
        map.off('render', logStats);
    }
});
</script>
</html>
