<!doctype html>
<html>
<head>
<meta charset="utf-8">
<script src="../dist/mapbox-gl.js"></script>
<style>.mapboxgl-canary { background-color: salmon; }</style>
</head>
<body style="margin: 0; padding: 0"><div id="map" style="width: 500px; height: 500px"></div></body>
<script>
mapboxgl.accessToken = 'pk.eyJ1IjoibW91cm5lciIsImEiOiJWWnRiWG1VIn0.j6eccFHpE3Q04XPLI7JxbA';
mapboxgl.workerCount = 1;

var map = new mapboxgl.Map({
    container: document.getElementById('map'),
    style: 'mapbox://styles/mapbox/streets-v11',
    center: [-77.07842066675323, 38.890315130853566],
    zoom: 11
});

const gl = map.painter.context && map.painter.context.gl || map.painter.gl;
const vao = map.painter.context && map.painter.context.extVertexArrayObject || map.painter.extVertexArrayObject;

const tileStats = {};
const frameStats = {};
let numFrames = 0;

function hookStats(stats, obj, methodName, statName = methodName, getStat) {
    const originalFn = obj[methodName];
    stats[statName] = 0;
    obj[methodName] = (...args) => {
        stats[statName] += getStat ? getStat(args) : 1;
        originalFn.call(obj, ...args);
    };
}

map.on('data', function onData(e) {
    if (!e.coord) return;
    // wait for the tile to load before collecting metrics

    map.off('data', onData);

    hookStats(tileStats, gl, 'bufferData');
    hookStats(tileStats, gl, 'bufferData', 'bufferData_bytes', (args) => args[1].byteLength);

    hookStats(frameStats, gl, 'bufferSubData');
    hookStats(frameStats, gl, 'bufferSubData', 'bufferSubData_bytes', (args) => args[2].byteLength);

    hookStats(tileStats, gl, 'texImage2D');
    hookStats(tileStats, gl, 'texImage2D', 'texImage2D_bytes',
        (args) => args[5] ? args[5].width * args[5].height : args[3] * args[4]);

    hookStats(tileStats, gl, 'texSubImage2D');
    hookStats(tileStats, gl, 'texSubImage2D', 'texSubImage2D_bytes',
        (args) => args[6] && args[6].width ? args[6].width * args[6].height : args[4] * args[5]);

    hookStats(frameStats, gl, 'drawElements', 'draw');
    hookStats(frameStats, gl, 'drawArrays', 'draw');
    hookStats(frameStats, gl, 'useProgram');
    hookStats(frameStats, vao, 'bindVertexArrayOES', 'bindVAO');

    map.on('render', () => numFrames++);
    map.once('moveend', () => {
        for (const id in frameStats) {
            frameStats[id] = Math.round(10 * frameStats[id] / numFrames) / 10;
        }
        console.log(JSON.stringify({tileStats, frameStats}, null, 2));
    });

    setTimeout(() => map.zoomTo(11.99, {duration: 5000, easing: (t) => t}), 1000);
});
</script>
</html>
